# 本地安装

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [requirements.txt](file://requirements.txt)
- [requirements_heavy.txt](file://requirements_heavy.txt)
- [requirements_light.txt](file://requirements_light.txt)
- [requirements_all.txt](file://requirements_all.txt)
- [uv.lock](file://uv.lock)
- [autodl_deploy.sh](file://autodl_deploy.sh)
- [download_models.py](file://download_models.py)
- [FAQ.md](file://FAQ.md)
</cite>

## 目录
1. [环境要求](#环境要求)
2. [使用uv包管理器安装](#使用uv包管理器安装)
3. [快速安装指南](#快速安装指南)
4. [配置国内镜像源](#配置国内镜像源)
5. [系统依赖项安装](#系统依赖项安装)
6. [故障排除](#故障排除)

## 环境要求

CosyVoice的本地安装需要满足特定的环境要求。根据项目文件分析，主要环境要求如下：

- **Python版本**: 项目明确要求Python 3.10版本。在`uv.lock`文件中，`requires-python = "==3.10.*"`表明项目仅兼容Python 3.10系列版本。
- **PyTorch版本**: 项目需要PyTorch 2.7.0版本。在`requirements_heavy.txt`文件中，`torch==2.7.0+cu128`和`torchaudio==2.7.0+cu128`明确指定了PyTorch的版本要求。
- **CUDA版本**: 项目需要CUDA 12.8支持。在`requirements_heavy.txt`文件中，多个依赖项如`torch==2.7.0+cu128`、`nvidia-cuda-cupti-cu12==12.8.57`等都指定了cu128后缀，表明需要CUDA 12.8版本。

这些环境要求确保了CosyVoice模型能够正确运行并充分利用GPU加速功能。

**Section sources**
- [uv.lock](file://uv.lock#L3)
- [requirements_heavy.txt](file://requirements_heavy.txt#L26-L27)

## 使用uv包管理器安装

CosyVoice推荐使用`uv`包管理器进行安装，以替代传统的`conda`或`pip`工具，从而获得更快的安装速度和更好的依赖管理。

### 安装uv包管理器

首先需要安装`uv`包管理器：

```sh
# 下载并安装uv（适用于Ubuntu Server）
curl -LsSf https://astral.sh/uv/install.sh | sh

# 将uv添加到当前会话的PATH
source $HOME/.local/bin/env

# 或者重新登录终端使PATH生效
```

### 创建虚拟环境

使用`uv`创建Python虚拟环境：

```sh
# 在项目根目录创建虚拟环境
uv venv .venv --python 3.10

# 激活虚拟环境
source .venv/bin/activate
```

### 安装项目依赖

安装CosyVoice的依赖项，项目提供了多个级别的依赖文件：

- `requirements.txt`: 基础依赖
- `requirements_light.txt`: 轻量级依赖
- `requirements_heavy.txt`: 重量级依赖，包含GPU相关组件
- `requirements_all.txt`: 所有依赖

推荐使用`requirements_heavy.txt`以获得完整的功能支持：

```sh
# 安装依赖
uv pip install --index-strategy unsafe-best-match -r requirements_heavy.txt
```

或者，如果需要排除某些可能安装失败的依赖（如TensorRT），可以先过滤：

```sh
# 过滤掉tensorrt相关依赖
grep -v "tensorrt" requirements.txt > requirements_temp.txt
uv pip install --index-strategy unsafe-best-match -r requirements_temp.txt
rm requirements_temp.txt
```

**Section sources**
- [README.md](file://README.md#L114-L156)
- [requirements_heavy.txt](file://requirements_heavy.txt)
- [requirements.txt](file://requirements.txt)

## 快速安装指南

CosyVoice提供了快速安装脚本，可以一键完成大部分安装步骤。虽然项目中没有直接的`install_uv.sh`文件，但存在类似的自动化脚本`autodl_deploy.sh`。

### 使用自动化脚本

```sh
# 克隆仓库
git clone --recursive https://github.com/FunAudioLLM/CosyVoice.git
cd CosyVoice

# 运行自动化部署脚本
chmod +x autodl_deploy.sh
./autodl_deploy.sh
```

该脚本会自动执行以下步骤：
1. 检查并安装`uv`包管理器
2. 克隆仓库并初始化子模块
3. 创建Python虚拟环境
4. 安装系统依赖
5. 解压并安装离线依赖包
6. 解压模型包
7. 安装TTSFRD组件
8. 启动服务

### 手动快速安装

如果不使用自动化脚本，可以按照以下步骤快速安装：

```sh
# 1. 克隆仓库
git clone --recursive https://github.com/FunAudioLLM/CosyVoice.git
cd CosyVoice

# 2. 安装uv（如果尚未安装）
curl -LsSf https://astral.sh/uv/install.sh | sh
source $HOME/.local/bin/env

# 3. 创建并激活虚拟环境
uv venv .venv --python 3.10
source .venv/bin/activate

# 4. 安装系统依赖
sudo apt-get update
sudo apt-get install -y git git-lfs sox libsox-dev build-essential curl wget ffmpeg unzip
git lfs install

# 5. 安装Python依赖
uv pip install --index-strategy unsafe-best-match -r requirements_heavy.txt
```

**Section sources**
- [autodl_deploy.sh](file://autodl_deploy.sh)
- [README.md](file://README.md#L88-L102)

## 配置国内镜像源

为了加速依赖包的下载，特别是在国内网络环境下，建议配置pip镜像源。

### 配置pip国内镜像

```sh
# 创建pip配置目录
mkdir -p ~/.config/pip

# 创建pip配置文件，使用阿里云镜像
cat > ~/.config/pip/pip.conf << EOF
[global]
index-url = https://mirrors.aliyun.com/pypi/simple/
trusted-host = mirrors.aliyun.com
EOF
```

### 其他可用的国内镜像源

除了阿里云，还可以使用其他国内镜像源：

- 清华大学: `https://pypi.tuna.tsinghua.edu.cn/simple/`
- 豆瓣: `https://pypi.douban.com/simple/`
- 中国科学技术大学: `https://pypi.mirrors.ustc.edu.cn/simple/`

配置方法类似，只需修改`index-url`和`trusted-host`的值。

### 验证镜像配置

配置完成后，可以通过以下命令验证是否生效：

```sh
# 查看当前pip配置
pip config list

# 测试安装一个小型包来验证速度
uv pip install requests
```

**Section sources**
- [README.md](file://README.md#L158-L166)

## 系统依赖项安装

CosyVoice需要安装一些系统级别的依赖项，这些依赖项无法通过pip安装，需要使用系统的包管理器。

### 安装必要的系统依赖

```sh
# 更新包列表
sudo apt-get update

# 安装必要的系统依赖
sudo apt-get install -y \
    git \
    git-lfs \
    sox \
    libsox-dev \
    build-essential \
    curl \
    wget \
    ffmpeg \
    unzip
```

### 配置git-lfs

Git Large File Storage (LFS)用于管理大型文件，如模型权重文件：

```sh
# 初始化git-lfs
git lfs install

# 验证git-lfs是否正常工作
git lfs version
```

### 各依赖项的作用

- **git-lfs**: 用于下载大型模型文件，这些文件通常存储在Git LFS中而不是直接存储在Git仓库中
- **sox和libsox-dev**: 音频处理库，用于音频文件的读取、转换和处理
- **ffmpeg**: 多媒体框架，用于音频和视频的编码、解码和转换
- **build-essential**: 包含编译C/C++代码所需的工具，如gcc、g++等
- **curl和wget**: 命令行下载工具，用于下载文件
- **unzip**: 用于解压zip格式的文件

**Section sources**
- [README.md](file://README.md#L126-L137)
- [autodl_deploy.sh](file://autodl_deploy.sh#L94-L98)

## 故障排除

在安装和使用CosyVoice过程中可能会遇到各种问题，以下是一些常见问题及其解决方案。

### git-lfs相关问题

#### 问题：无法找到resource.zip或无法解压resource.zip

这是最常见的问题之一，通常是由于git-lfs未正确安装或配置导致的。

**解决方案**：

```sh
# 确保git-lfs已安装
git lfs install

# 如果已经克隆了仓库，尝试重新获取LFS文件
git lfs pull

# 或者重新克隆仓库
git clone --recursive https://github.com/FunAudioLLM/CosyVoice.git
```

如果上述方法无效，可以手动下载：

```sh
# 手动下载ttsfrd资源
git clone https://www.modelscope.cn/iic/CosyVoice-ttsfrd.git pretrained_models/CosyVoice-ttsfrd
cd pretrained_models/CosyVoice-ttsfrd/
unzip resource.zip -d .
pip install ttsfrd_dependency-0.1-py3-none-any.whl
pip install ttsfrd-0.4.2-cp310-cp310-linux_x86_64.whl
```

### 依赖冲突问题

#### 问题：PyTorch版本冲突

由于CosyVoice需要特定版本的PyTorch（2.7.0+cu128），可能会与其他项目产生冲突。

**解决方案**：

1. **使用独立的虚拟环境**：为CosyVoice创建独立的虚拟环境，避免与其他项目冲突。
2. **使用conda环境**：如果使用conda，可以创建专门的conda环境：
   ```sh
   conda create -n cosyvoice python=3.10
   conda activate cosyvoice
   pip install torch==2.7.0+cu128 torchaudio==2.7.0+cu128 --index-url https://download.pytorch.org/whl/cu128
   ```

#### 问题：依赖安装失败

有时某些依赖包可能因网络问题或版本不兼容而安装失败。

**解决方案**：

1. **使用国内镜像源**：如前所述，配置pip使用国内镜像源。
2. **跳过可选依赖**：如README中建议，可以跳过TensorRT等可能安装失败的可选依赖：
   ```sh
   grep -v "tensorrt" requirements.txt > requirements_temp.txt
   uv pip install -r requirements_temp.txt
   ```
3. **离线安装**：对于网络环境较差的情况，可以预先下载所有依赖包进行离线安装。

### 子模块相关问题

#### 问题：ModuleNotFoundError: No module named 'matcha'

这是因为`Matcha-TTS`作为第三方模块以git子模块的形式存在，未正确初始化。

**解决方案**：

```sh
# 初始化并更新所有子模块
git submodule update --init --recursive

# 如果已经克隆了仓库但子模块未更新
cd third_party/Matcha-TTS
git checkout main  # 确保在正确的分支
```

此外，还需要设置PYTHONPATH：

```sh
export PYTHONPATH=third_party/Matcha-TTS
```

### 模型下载问题

#### 问题：模型下载失败

模型文件通常较大，下载可能因网络中断而失败。

**解决方案**：

1. **使用download_models.py脚本**：项目提供了`download_models.py`脚本，支持断点续传：
   ```sh
   python download_models.py
   ```
2. **手动下载**：从ModelScope或HuggingFace手动下载模型文件并放置到`pretrained_models`目录。

**Section sources**
- [FAQ.md](file://FAQ.md)
- [download_models.py](file://download_models.py)
- [autodl_deploy.sh](file://autodl_deploy.sh#L156-L168)