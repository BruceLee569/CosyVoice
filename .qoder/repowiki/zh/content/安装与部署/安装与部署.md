# 安装与部署

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [requirements.txt](file://requirements.txt)
- [requirements_all.txt](file://requirements_all.txt)
- [uv.lock](file://uv.lock)
- [pyproject.toml](file://pyproject.toml)
- [download_models.py](file://download_models.py)
- [autodl_deploy.sh](file://autodl_deploy.sh)
- [docker/Dockerfile](file://docker/Dockerfile)
- [runtime/python/Dockerfile](file://runtime/python/Dockerfile)
- [AUTODL_DEPLOYMENT_GUIDE.md](file://AUTODL_DEPLOYMENT_GUIDE.md)
- [FAQ.md](file://FAQ.md)
</cite>

## 目录
1. [环境要求](#环境要求)
2. [使用uv安装](#使用uv安装)
3. [快速安装指南](#快速安装指南)
4. [模型下载](#模型下载)
5. [可选的ttsfrd包安装](#可选的ttsfrd包安装)
6. [Docker部署](#docker部署)
7. [AutoDL环境部署](#autodl环境部署)
8. [故障排除](#故障排除)

## 环境要求
CosyVoice的安装和部署需要满足特定的环境要求。项目明确要求使用Python 3.10版本，这在`uv.lock`和`pyproject.toml`文件中均有定义。对于深度学习框架，项目依赖于PyTorch 2.7.0和CUDA 12.8，这些版本在`requirements_all.txt`和`pyproject.toml`中被严格指定，以确保与TensorRT-LLM等组件的兼容性。此外，系统需要安装`git-lfs`来处理大型模型文件，以及`ffmpeg`、`sox`等音频处理工具。推荐在Ubuntu Server环境下进行安装，以获得最佳的兼容性和性能。

**Section sources**
- [uv.lock](file://uv.lock#L3)
- [pyproject.toml](file://pyproject.toml#L6)
- [requirements_all.txt](file://requirements_all.txt#L194-L195)
- [README.md](file://README.md#L133)

## 使用uv安装
`uv`是一个快速的Python包管理器，被推荐用于替代`conda`以获得更快的安装速度。首先，通过官方脚本安装`uv`：
```sh
curl -LsSf https://astral.sh/uv/install.sh | sh
```
安装完成后，将`uv`添加到PATH环境变量中：
```sh
source $HOME/.local/bin/env
```
接下来，创建一个Python虚拟环境并激活它：
```sh
uv venv
source .venv/bin/activate
```
最后，使用`uv`安装项目依赖。由于`requirements.txt`中包含可能安装失败的`tensorrt`包，建议先过滤掉它再进行安装：
```sh
grep -v "tensorrt" requirements.txt > requirements_temp.txt
uv pip install --index-strategy unsafe-best-match -r requirements_temp.txt
rm requirements_temp.txt
```
或者，可以使用`uv run`命令直接运行Python脚本而无需手动激活环境。

**Section sources**
- [README.md](file://README.md#L117-L153)
- [pyproject.toml](file://pyproject.toml)

## 快速安装指南
为了简化安装过程，项目提供了一个名为`install_uv.sh`的一键安装脚本。使用此脚本可以自动化完成所有安装步骤。首先，克隆仓库并进入项目目录：
```sh
git clone --recursive https://github.com/FunAudioLLM/CosyVoice.git
cd CosyVoice
```
然后，赋予脚本执行权限并运行：
```sh
chmod +x install_uv.sh
./install_uv.sh
```
该脚本会自动处理`uv`的安装、虚拟环境的创建以及依赖包的安装。安装完成后，按照脚本输出的提示进行后续的模型下载和服务器启动操作。

**Section sources**
- [README.md](file://README.md#L92-L102)

## 模型下载
预训练模型是CosyVoice正常运行的关键。可以使用`download_models.py`脚本或直接使用`modelscope`/`huggingface_hub` SDK来下载模型。推荐的模型包括Fun-CosyVoice3-0.5B和CosyVoice2-0.5B。

使用SDK下载的代码示例如下：
```python
# 从ModelScope下载
from modelscope import snapshot_download
snapshot_download('FunAudioLLM/Fun-CosyVoice3-0.5B-2512', local_dir='pretrained_models/Fun-CosyVoice3-0.5B')
snapshot_download('iic/CosyVoice2-0.5B', local_dir='pretrained_models/CosyVoice2-0.5B')

# 从HuggingFace下载（海外用户）
from huggingface_hub import snapshot_download
snapshot_download('FunAudioLLM/Fun-CosyVoice3-0.5B-2512', local_dir='pretrained_models/Fun-CosyVoice3-0.5B')
snapshot_download('FunAudioLLM/CosyVoice2-0.5B', local_dir='pretrained_models/CosyVoice2-0.5B')
```

或者，使用`download_models.py`脚本进行下载：
```sh
# 下载推荐模型（2.0, 2.0-llm, tts）
python download_models.py

# 仅下载特定模型
python download_models.py --model 2.0
```
该脚本支持断点续传和代理配置，非常适合在不稳定的网络环境中使用。

**Section sources**
- [README.md](file://README.md#L173-L189)
- [download_models.py](file://download_models.py)

## 可选的ttsfrd包安装
`ttsfrd`是一个可选的文本规范化包，用于提升文本处理的性能。如果未安装此包，系统将默认使用`wetext`。安装`ttsfrd`需要先下载其资源包，然后安装相应的wheel文件：
```sh
cd pretrained_models/CosyVoice-ttsfrd/
unzip resource.zip -d .
pip install ttsfrd_dependency-0.1-py3-none-any.whl
pip install ttsfrd-0.4.2-cp310-cp310-linux_x86_64.whl
```
此步骤并非必需，但建议安装以获得更好的文本处理效果。

**Section sources**
- [README.md](file://README.md#L197-L201)
- [FAQ.md](file://FAQ.md#L12-L15)

## Docker部署
Docker提供了一种便捷的部署方式，可以确保环境的一致性。项目提供了两个Dockerfile，分别位于`docker/`和`runtime/python/`目录下。

使用`runtime/python/Dockerfile`构建镜像：
```sh
cd runtime/python
docker build -t cosyvoice:v1.0 .
```

启动服务容器：
```sh
# 使用gRPC
docker run -d --runtime=nvidia -p 50000:50000 cosyvoice:v1.0 /bin/bash -c "cd /opt/CosyVoice/CosyVoice/runtime/python/grpc && python3 server.py --port 50000 --max_conc 4 --model_dir iic/CosyVoice-300M && sleep infinity"

# 使用FastAPI
docker run -d --runtime=nvidia -p 50000:50000 cosyvoice:v1.0 /bin/bash -c "cd /opt/CosyVoice/CosyVoice/runtime/python/fastapi && python3 server.py --port 50000 --model_dir iic/CosyVoice-300M && sleep infinity"
```

**Section sources**
- [README.md](file://README.md#L244-L252)
- [runtime/python/Dockerfile](file://runtime/python/Dockerfile)

## AutoDL环境部署
在AutoDL等特定云环境中，部署流程有所不同。项目提供了一个名为`autodl_deploy.sh`的专用脚本。该脚本会自动处理网络加速、离线依赖包的解压和安装、模型包的解压以及服务的启动。

使用方法如下：
```bash
# 首先，确保已将 offline_packages.zip 和 pretrained_models.zip 上传到 /root/autodl-tmp
source /etc/network_turbo && bash autodl_deploy.sh
```
对于使用TensorRT-LLM的场景，由于MPI初始化问题，不能直接运行`python fast_server.py`。必须使用`mpirun`来启动服务：
```bash
mpirun -n 1 --allow-run-as-root --bind-to none python fast_server.py
```
或使用项目提供的`start_server_mpi.sh`脚本。

**Section sources**
- [autodl_deploy.sh](file://autodl_deploy.sh)
- [AUTODL_DEPLOYMENT_GUIDE.md](file://AUTODL_DEPLOYMENT_GUIDE.md)

## 故障排除
在安装和部署过程中可能会遇到各种问题。最常见的问题是`git-lfs`相关错误，导致模型文件下载不完整。解决方法是确保已正确安装`git-lfs`并执行`git lfs install`。

如果遇到`ModuleNotFoundError: No module named 'matcha'`，请检查`third_party`目录，并执行`git submodule update --init --recursive`来初始化子模块。

对于在AutoDL上`import tensorrt_llm`卡死的问题，根本原因是TensorRT-LLM在导入时会尝试初始化MPI环境。解决方案是使用`mpirun -n 1`来启动Python脚本，以提供完整的MPI运行时环境。

**Section sources**
- [FAQ.md](file://FAQ.md)
- [AUTODL_DEPLOYMENT_GUIDE.md](file://AUTODL_DEPLOYMENT_GUIDE.md)